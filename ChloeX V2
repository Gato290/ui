-- main.lua V0.1.0 - Chloe X UI with Keybind Support (Optimized)
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local MarketplaceService = game:GetService("MarketplaceService")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local viewport = workspace.CurrentCamera.ViewportSize

-- Load modules dengan error handling yang lebih baik
local function loadModule(url, moduleName)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    
    if not success then
        warn(string.format("Failed to load %s module: %s", moduleName, tostring(result)))
        return nil
    end
    return result
end

-- Load semua modules
local Colors = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/color.lua", "Color") or {
    ["Default"] = Color3.fromRGB(20, 20, 25),
    ["Light"] = Color3.fromRGB(240, 240, 240)
}

local ElementsModule = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/Elements.lua", "Elements")
local Icons = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/Icon.lua", "Icons") or {}
local LucideIcons = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/LucideIcon.lua", "Lucide Icons") or {}
local SolarIcons = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/SolarIcon.lua", "Solar Icons") or {}
local UserInfo = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/showuser.lua", "User Info") or {}
local KeybindModule = loadModule("https://raw.githubusercontent.com/Gato290/ui/refs/heads/main/Elements/keybind.lua", "Keybind")

if not ElementsModule then
    warn("Elements module is required! Exiting...")
    return
end

local Elements = ElementsModule

-- Variabel global
local CURRENT_CONFIG_NAME = "NexaHub"
local ConfigData = {}
local CURRENT_VERSION = nil
local ConfigFile = ""
local DEFAULT_NOTIFY_SIZE = 320
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled and not UserInputService.MouseEnabled

-- Helper functions
local function getIcon(iconString)
    if not iconString or iconString == "" then return "" end
    
    if iconString:find("^lucide:") then
        local iconName = iconString:sub(8)
        return LucideIcons[iconName] or ""
    elseif iconString:find("^solar:") then
        local iconName = iconString:sub(7)
        return SolarIcons[iconName] or ""
    else
        return Icons[iconString] or iconString
    end
end

local function getColorFromString(colorString)
    if type(colorString) == "string" then
        return Colors[colorString] or Colors["Default"] or Color3.fromRGB(20, 20, 25)
    elseif type(colorString) == "userdata" and typeof(colorString) == "Color3" then
        return colorString
    end
    return Colors["Default"] or Color3.fromRGB(20, 20, 25)
end

local function safeSize(pxWidth, pxHeight)
    local scaleX = pxWidth / viewport.X
    local scaleY = pxHeight / viewport.Y
    
    if isMobile then
        scaleX = math.min(scaleX, 0.5)
        scaleY = math.min(scaleY, 0.3)
    end
    
    return UDim2.new(scaleX, 0, scaleY, 0)
end

local function applyUITransparency(mainObject, transparency)
    if not mainObject or type(transparency) ~= "number" then return false end
    if transparency < 0 or transparency > 1 then return false end
    
    if mainObject:IsA("ImageLabel") then
        mainObject.ImageTransparency = transparency
    else
        mainObject.BackgroundTransparency = transparency
    end
    return true
end

-- Config functions
local function saveConfig()
    if not writefile or ConfigFile == "" then return end
    
    ConfigData._version = CURRENT_VERSION
    local success, json = pcall(function()
        return HttpService:JSONEncode(ConfigData)
    end)
    
    if success then
        writefile(ConfigFile, json)
    end
end

local function loadConfigFromFile()
    if not CURRENT_VERSION or ConfigFile == "" or not isfile then return end
    
    if isfile(ConfigFile) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(ConfigFile))
        end)
        
        if success and type(data) == "table" and data._version == CURRENT_VERSION then
            ConfigData = data
        else
            ConfigData = { _version = CURRENT_VERSION }
        end
    else
        ConfigData = { _version = CURRENT_VERSION }
    end
end

local function loadConfigElements()
    for key, element in pairs(Elements.GetAll() or {}) do
        if ConfigData[key] ~= nil and element.Set then
            element:Set(ConfigData[key], true)
        end
    end
end

-- Draggable functionality
local function makeDraggable(topbarObject, object)
    local dragging = false
    local dragInput, dragStart, startPosition
    
    local function update(input)
        local delta = input.Position - dragStart
        object.Position = UDim2.new(
            startPosition.X.Scale,
            startPosition.X.Offset + delta.X,
            startPosition.Y.Scale,
            startPosition.Y.Offset + delta.Y
        )
    end
    
    topbarObject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPosition = object.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    topbarObject.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    -- Resize functionality
    local minSizeX, minSizeY = 100, 100
    local defSizeX, defSizeY = isMobile and 470 or 640, isMobile and 270 or 400
    
    object.Size = UDim2.new(0, defSizeX, 0, defSizeY)
    
    local resizeHandle = Instance.new("Frame")
    resizeHandle.AnchorPoint = Vector2.new(1, 1)
    resizeHandle.BackgroundTransparency = 1
    resizeHandle.Size = UDim2.new(0, 40, 0, 40)
    resizeHandle.Position = UDim2.new(1, 20, 1, 20)
    resizeHandle.Name = "ResizeHandle"
    resizeHandle.Parent = object
    
    local resizing = false
    local resizeStart, startSize
    
    local function updateSize(input)
        local delta = input.Position - resizeStart
        local newWidth = math.max(startSize.X.Offset + delta.X, minSizeX)
        local newHeight = math.max(startSize.Y.Offset + delta.Y, minSizeY)
        
        TweenService:Create(object, TweenInfo.new(0.2), {
            Size = UDim2.new(0, newWidth, 0, newHeight)
        }):Play()
    end
    
    resizeHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = true
            resizeStart = input.Position
            startSize = object.Size
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    resizing = false
                end
            end)
        end
    end)
    
    resizeHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and resizing then
            updateSize(input)
        end
    end)
end

local function createClickEffect(button, x, y)
    task.spawn(function()
        button.ClipsDescendants = true
        
        local circle = Instance.new("ImageLabel")
        circle.Image = "rbxassetid://266543268"
        circle.ImageColor3 = Color3.fromRGB(80, 80, 80)
        circle.ImageTransparency = 0.9
        circle.BackgroundTransparency = 1
        circle.ZIndex = 10
        circle.Name = "ClickEffect"
        circle.Parent = button
        
        local relativeX = x - circle.AbsolutePosition.X
        local relativeY = y - circle.AbsolutePosition.Y
        circle.Position = UDim2.new(0, relativeX, 0, relativeY)
        
        local size = math.max(button.AbsoluteSize.X, button.AbsoluteSize.Y) * 1.5
        
        circle:TweenSizeAndPosition(
            UDim2.new(0, size, 0, size),
            UDim2.new(0.5, -size/2, 0.5, -size/2),
            Enum.EasingDirection.Out,
            Enum.EasingStyle.Quad,
            0.5,
            false
        )
        
        for i = 1, 10 do
            circle.ImageTransparency = circle.ImageTransparency + 0.01
            task.wait(0.05)
        end
        
        circle:Destroy()
    end)
end

-- Notification system
local Chloex = {}

function Chloex:MakeNotify(config)
    config = config or {}
    config.Title = config.Title or "Chloe X"
    config.Description = config.Description or "Notification"
    config.Content = config.Content or "Content"
    config.Color = getColorFromString(config.Color or "Default")
    config.Time = config.Time or 0.5
    config.Delay = config.Delay or 5
    config.Icon = config.Icon or ""
    config.NotifySize = config.NotifySize or DEFAULT_NOTIFY_SIZE
    config.Mini = config.Mini or false
    
    local notifyFunc = {}
    
    task.spawn(function()
        -- Setup notify GUI
        local notifyGui = CoreGui:FindFirstChild("NotifyGui")
        if not notifyGui then
            notifyGui = Instance.new("ScreenGui")
            notifyGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
            notifyGui.Name = "NotifyGui"
            notifyGui.Parent = CoreGui
        end
        
        local notifyLayout = notifyGui:FindFirstChild("NotifyLayout")
        if not notifyLayout then
            notifyLayout = Instance.new("Frame")
            notifyLayout.AnchorPoint = Vector2.new(1, 1)
            notifyLayout.BackgroundTransparency = 1
            notifyLayout.BorderSizePixel = 0
            notifyLayout.Position = UDim2.new(1, -30, 1, -30)
            notifyLayout.Size = UDim2.new(0, config.NotifySize, 1, 0)
            notifyLayout.Name = "NotifyLayout"
            notifyLayout.Parent = notifyGui
            notifyLayout:SetAttribute("NotifySize", config.NotifySize)
            
            -- Reorder notifications
            local function reorderNotifications()
                local count = 0
                for _, child in ipairs(notifyLayout:GetChildren()) do
                    if child:IsA("Frame") then
                        TweenService:Create(
                            child,
                            TweenInfo.new(0.3, Enum.EasingStyle.Quad),
                            { Position = UDim2.new(0, 0, 1, -((child.Size.Y.Offset + 12) * count)) }
                        ):Play()
                        count = count + 1
                    end
                end
            end
            
            notifyLayout.ChildRemoved:Connect(reorderNotifications)
        else
            local currentSize = notifyLayout:GetAttribute("NotifySize") or DEFAULT_NOTIFY_SIZE
            if currentSize ~= config.NotifySize then
                notifyLayout.Size = UDim2.new(0, config.NotifySize, 1, 0)
                notifyLayout:SetAttribute("NotifySize", config.NotifySize)
            end
        end
        
        -- Calculate position
        local notifyPosHeight = 0
        for _, child in ipairs(notifyLayout:GetChildren()) do
            if child:IsA("Frame") then
                notifyPosHeight = -(child.Position.Y.Offset) + child.Size.Y.Offset + 12
            end
        end
        
        -- Create notification frame
        local notifyFrame = Instance.new("Frame")
        notifyFrame.BackgroundTransparency = 1
        notifyFrame.BorderSizePixel = 0
        notifyFrame.Size = UDim2.new(1, 0, 0, 150)
        notifyFrame.Name = "NotifyFrame"
        notifyFrame.Parent = notifyLayout
        notifyFrame.AnchorPoint = Vector2.new(0, 1)
        notifyFrame.Position = UDim2.new(0, 0, 1, -notifyPosHeight)
        
        local notifyFrameReal = Instance.new("Frame")
        notifyFrameReal.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        notifyFrameReal.BorderSizePixel = 0
        notifyFrameReal.Position = UDim2.new(0, 400, 0, 0)
        notifyFrameReal.Size = UDim2.new(1, 0, 1, 0)
        notifyFrameReal.Name = "NotifyFrameReal"
        notifyFrameReal.Parent = notifyFrame
        
        local uiCorner = Instance.new("UICorner")
        uiCorner.CornerRadius = UDim.new(0, 8)
        uiCorner.Parent = notifyFrameReal
        
        -- Top bar
        local top = Instance.new("Frame")
        top.BackgroundTransparency = 1
        top.BorderSizePixel = 0
        top.Size = UDim2.new(1, 0, 0, config.Mini and 24 or 36)
        top.Name = "Top"
        top.Parent = notifyFrameReal
        
        -- Icon
        local iconImage = getIcon(config.Icon)
        if iconImage ~= "" then
            local iconLabel = Instance.new("ImageLabel")
            iconLabel.Image = iconImage
            iconLabel.BackgroundTransparency = 1
            iconLabel.BorderSizePixel = 0
            iconLabel.Size = UDim2.new(0, config.Mini and 12 or 16, 0, config.Mini and 12 or 16)
            iconLabel.Position = UDim2.new(0, config.Mini and 6 or 10, 0.5, -(config.Mini and 6 or 8))
            iconLabel.AnchorPoint = Vector2.new(0, 0.5)
            iconLabel.Name = "IconLabel"
            iconLabel.Parent = top
        end
        
        -- Title
        local titleLabel = Instance.new("TextLabel")
        titleLabel.Font = Enum.Font.GothamBold
        titleLabel.Text = config.Title
        titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        titleLabel.TextSize = config.Mini and 11 or 14
        titleLabel.TextXAlignment = Enum.TextXAlignment.Left
        titleLabel.BackgroundTransparency = 1
        titleLabel.BorderSizePixel = 0
        titleLabel.Size = UDim2.new(1, -100, 1, 0)
        
        local xOffset = 0
        if iconImage ~= "" then
            xOffset = config.Mini and 24 or 35
        else
            xOffset = config.Mini and 6 or 10
        end
        titleLabel.Position = UDim2.new(0, xOffset, 0, 0)
        titleLabel.Parent = top
        
        -- Description
        local descLabel = Instance.new("TextLabel")
        descLabel.Font = Enum.Font.GothamBold
        descLabel.Text = config.Description
        descLabel.TextColor3 = config.Color
        descLabel.TextSize = config.Mini and 10 or 14
        descLabel.TextXAlignment = Enum.TextXAlignment.Left
        descLabel.BackgroundTransparency = 1
        descLabel.BorderSizePixel = 0
        descLabel.Size = UDim2.new(1, 0, 1, 0)
        descLabel.Position = UDim2.new(0, titleLabel.TextBounds.X + xOffset + 5, 0, 0)
        descLabel.Parent = top
        
        -- Close button
        local closeBtn = Instance.new("TextButton")
        closeBtn.Text = ""
        closeBtn.BackgroundTransparency = 1
        closeBtn.BorderSizePixel = 0
        closeBtn.Size = UDim2.new(0, config.Mini and 20 or 25, 0, config.Mini and 20 or 25)
        closeBtn.Position = UDim2.new(1, -(config.Mini and 5 or 8), 0.5, 0)
        closeBtn.AnchorPoint = Vector2.new(1, 0.5)
        closeBtn.Name = "Close"
        closeBtn.Parent = top
        
        local closeIcon = Instance.new("ImageLabel")
        closeIcon.Image = "rbxassetid://9886659671"
        closeIcon.BackgroundTransparency = 1
        closeIcon.BorderSizePixel = 0
        closeIcon.Size = UDim2.new(1, -(config.Mini and 6 or 8), 1, -(config.Mini and 6 or 8))
        closeIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
        closeIcon.AnchorPoint = Vector2.new(0.5, 0.5)
        closeIcon.Parent = closeBtn
        
        -- Content
        local contentLabel = Instance.new("TextLabel")
        contentLabel.Font = Enum.Font.GothamBold
        contentLabel.Text = config.Content
        contentLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        contentLabel.TextSize = config.Mini and 11 or 13
        contentLabel.TextXAlignment = Enum.TextXAlignment.Left
        contentLabel.TextYAlignment = Enum.TextYAlignment.Top
        contentLabel.TextWrapped = true
        contentLabel.BackgroundTransparency = 1
        contentLabel.BorderSizePixel = 0
        contentLabel.Position = UDim2.new(0, config.Mini and 6 or 10, 0, config.Mini and 22 or 27)
        contentLabel.Size = UDim2.new(1, -(config.Mini and 12 or 20), 0, 13)
        contentLabel.Parent = notifyFrameReal
        
        -- Calculate height
        local textBoundsX = contentLabel.TextBounds.X
        local frameWidth = config.NotifySize - 40
        local linesNeeded = math.ceil(textBoundsX / math.max(frameWidth, 1))
        local lineHeight = config.Mini and 11 or 13
        
        if linesNeeded > 1 then
            contentLabel.Size = UDim2.new(1, -(config.Mini and 12 or 20), 0, lineHeight * linesNeeded)
        end
        
        local contentHeight = contentLabel.AbsoluteSize.Y
        local minHeight = config.Mini and 45 or 65
        local maxHeight = config.Mini and 150 or 250
        local headerHeight = config.Mini and 24 or 36
        local finalHeight = math.clamp(contentHeight + headerHeight + 4, minHeight, maxHeight)
        
        if finalHeight == maxHeight then
            local maxContentHeight = maxHeight - headerHeight - 10
            contentLabel.Size = UDim2.new(1, -(config.Mini and 12 or 20), 0, maxContentHeight)
        end
        
        notifyFrame.Size = UDim2.new(1, 0, 0, finalHeight)
        
        -- Close function
        local isClosing = false
        function notifyFunc:Close()
            if isClosing then return false end
            isClosing = true
            
            TweenService:Create(
                notifyFrameReal,
                TweenInfo.new(config.Time, Enum.EasingStyle.Back),
                { Position = UDim2.new(0, 400, 0, 0) }
            ):Play()
            
            task.wait(config.Time / 1.2)
            notifyFrame:Destroy()
            return true
        end
        
        closeBtn.Activated:Connect(function()
            notifyFunc:Close()
        end)
        
        -- Animate in
        TweenService:Create(
            notifyFrameReal,
            TweenInfo.new(config.Time, Enum.EasingStyle.Back),
            { Position = UDim2.new(0, 0, 0, 0) }
        ):Play()
        
        -- Auto close
        task.wait(config.Delay)
        notifyFunc:Close()
    end)
    
    return notifyFunc
end

function Notify(msg, delay, color, title, desc, icon, notifySize, mini)
    return Chloex:MakeNotify({
        Title = title or CURRENT_CONFIG_NAME,
        Description = desc or "Notification",
        Content = msg or "Content",
        Color = getColorFromString(color or "Default"),
        Delay = delay or 4,
        Icon = icon or "",
        NotifySize = notifySize or DEFAULT_NOTIFY_SIZE,
        Mini = mini or false
    })
end

function MiniNotify(msg, delay, color, title, desc, icon, notifySize)
    return Notify(msg, delay or 3, color, title or CURRENT_CONFIG_NAME, desc or "Info", icon, notifySize or 200, true)
end

-- Window creation
function Chloex:Window(guiConfig)
    guiConfig = guiConfig or {}
    guiConfig.Title = guiConfig.Title or "Chloe X"
    guiConfig.Footer = guiConfig.Footer or "Chloee :3"
    guiConfig.Color = getColorFromString(guiConfig.Color or "Default")
    guiConfig["Tab Width"] = guiConfig["Tab Width"] or 120
    guiConfig.Version = guiConfig.Version or 1
    guiConfig.Configname = guiConfig.Configname or "NexaHub"
    guiConfig.Image = guiConfig.Image or "71947103252559"
    guiConfig.Uitransparent = guiConfig.Uitransparent or 0
    guiConfig.ThemeTransparency = guiConfig.ThemeTransparency or 0
    guiConfig.ShowUser = guiConfig.ShowUser or false
    guiConfig.UserProfileType = guiConfig.UserProfileType or "simple"
    guiConfig.NotifySize = guiConfig.NotifySize or 320
    
    CURRENT_CONFIG_NAME = guiConfig.Configname
    DEFAULT_NOTIFY_SIZE = guiConfig.NotifySize
    
    -- Setup config folder
    local configFolderName = guiConfig.Configname:gsub("%s+", "_")
    
    if isfolder and not isfolder(configFolderName) then
        makefolder(configFolderName)
    end
    
    if isfolder and not isfolder(configFolderName .. "/Config") then
        makefolder(configFolderName .. "/Config")
    end
    
    local gameName = tostring(MarketplaceService:GetProductInfo(game.PlaceId).Name)
    gameName = gameName:gsub("[^%w_ ]", ""):gsub("%s+", "_")
    
    ConfigFile = configFolderName .. "/Config/CHX_" .. gameName .. ".json"
    CURRENT_VERSION = guiConfig.Version
    
    loadConfigFromFile()
    Elements.Initialize(guiConfig.Color, saveConfig, ConfigData)
    
    local guiFunc = {}
    
    -- Create main GUI
    local screenGui = Instance.new("ScreenGui")
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Name = "Chloeex"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = CoreGui
    
    -- Drop shadow
    local shadowHolder = Instance.new("Frame")
    shadowHolder.BackgroundTransparency = 1
    shadowHolder.BorderSizePixel = 0
    shadowHolder.AnchorPoint = Vector2.new(0.5, 0.5)
    shadowHolder.Position = UDim2.new(0.5, 0, 0.5, 0)
    shadowHolder.Size = safeSize(640, 400)
    shadowHolder.ZIndex = 0
    shadowHolder.Name = "DropShadowHolder"
    shadowHolder.Parent = screenGui
    
    local shadow = Instance.new("ImageLabel")
    shadow.Image = "rbxassetid://6015897843"
    shadow.ImageColor3 = Color3.fromRGB(15, 15, 15)
    shadow.ImageTransparency = 1
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(49, 49, 450, 450)
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.BackgroundTransparency = 1
    shadow.BorderSizePixel = 0
    shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
    shadow.Size = UDim2.new(1, 47, 1, 47)
    shadow.ZIndex = 0
    shadow.Name = "DropShadow"
    shadow.Parent = shadowHolder
    
    -- Main window
    local main
    if guiConfig.Theme then
        main = Instance.new("ImageLabel")
        main.Image = "rbxassetid://" .. guiConfig.Theme
        main.ScaleType = Enum.ScaleType.Crop
        main.BackgroundTransparency = 1
        main.ImageTransparency = guiConfig.ThemeTransparency
    else
        main = Instance.new("Frame")
        main.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        main.BackgroundTransparency = guiConfig.Uitransparent
    end
    
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BorderSizePixel = 0
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.Size = UDim2.new(1, -47, 1, -47)
    main.Name = "Main"
    main.Parent = shadow
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.Parent = main
    
    -- Top bar
    local top = Instance.new("Frame")
    top.BackgroundTransparency = 1
    top.BorderSizePixel = 0
    top.Size = UDim2.new(1, 0, 0, 38)
    top.Name = "Top"
    top.Parent = main
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = guiConfig.Title
    titleLabel.TextColor3 = guiConfig.Color
    titleLabel.TextSize = 14
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.BackgroundTransparency = 1
    titleLabel.BorderSizePixel = 0
    titleLabel.Size = UDim2.new(1, -100, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Parent = top
    
    local footerLabel = Instance.new("TextLabel")
    footerLabel.Font = Enum.Font.GothamBold
    footerLabel.Text = guiConfig.Footer
    footerLabel.TextColor3 = guiConfig.Color
    footerLabel.TextSize = 14
    footerLabel.TextXAlignment = Enum.TextXAlignment.Left
    footerLabel.BackgroundTransparency = 1
    footerLabel.BorderSizePixel = 0
    footerLabel.Size = UDim2.new(1, -(titleLabel.TextBounds.X + 104), 1, 0)
    footerLabel.Position = UDim2.new(0, titleLabel.TextBounds.X + 15, 0, 0)
    footerLabel.Parent = top
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Text = ""
    closeBtn.BackgroundTransparency = 1
    closeBtn.BorderSizePixel = 0
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -8, 0.5, 0)
    closeBtn.AnchorPoint = Vector2.new(1, 0.5)
    closeBtn.Name = "Close"
    closeBtn.Parent = top
    
    local closeIcon = Instance.new("ImageLabel")
    closeIcon.Image = "rbxassetid://9886659671"
    closeIcon.BackgroundTransparency = 1
    closeIcon.BorderSizePixel = 0
    closeIcon.Size = UDim2.new(1, -8, 1, -8)
    closeIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
    closeIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    closeIcon.Parent = closeBtn
    
    -- Minimize button
    local minBtn = Instance.new("TextButton")
    minBtn.Text = ""
    minBtn.BackgroundTransparency = 1
    minBtn.BorderSizePixel = 0
    minBtn.Size = UDim2.new(0, 25, 0, 25)
    minBtn.Position = UDim2.new(1, -38, 0.5, 0)
    minBtn.AnchorPoint = Vector2.new(1, 0.5)
    minBtn.Name = "Min"
    minBtn.Parent = top
    
    local minIcon = Instance.new("ImageLabel")
    minIcon.Image = "rbxassetid://9886659276"
    minIcon.BackgroundTransparency = 1
    minIcon.ImageTransparency = 0.2
    minIcon.BorderSizePixel = 0
    minIcon.Size = UDim2.new(1, -9, 1, -9)
    minIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
    minIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    minIcon.Parent = minBtn
    
    -- Divider
    local divider = Instance.new("Frame")
    divider.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    divider.BackgroundTransparency = 0.85
    divider.BorderSizePixel = 0
    divider.Position = UDim2.new(0.5, 0, 0, 38)
    divider.Size = UDim2.new(1, 0, 0, 1)
    divider.AnchorPoint = Vector2.new(0.5, 0)
    divider.Name = "Divider"
    divider.Parent = main
    
    -- Content area
    local layers = Instance.new("Frame")
    layers.BackgroundTransparency = 1
    layers.BorderSizePixel = 0
    layers.Position = UDim2.new(0, guiConfig["Tab Width"] + 18, 0, 50)
    layers.Size = UDim2.new(1, -(guiConfig["Tab Width"] + 27), 1, -59)
    layers.Name = "Layers"
    layers.Parent = main
    
    local layersCorner = Instance.new("UICorner")
    layersCorner.CornerRadius = UDim.new(0, 2)
    layersCorner.Parent = layers
    
    local tabNameLabel = Instance.new("TextLabel")
    tabNameLabel.Font = Enum.Font.GothamBold
    tabNameLabel.Text = ""
    tabNameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    tabNameLabel.TextSize = 24
    tabNameLabel.TextWrapped = true
    tabNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    tabNameLabel.BackgroundTransparency = 1
    tabNameLabel.BorderSizePixel = 0
    tabNameLabel.Size = UDim2.new(1, 0, 0, 30)
    tabNameLabel.Name = "TabName"
    tabNameLabel.Parent = layers
    
    local layersReal = Instance.new("Frame")
    layersReal.BackgroundTransparency = 1
    layersReal.BorderSizePixel = 0
    layersReal.ClipsDescendants = true
    layersReal.Position = UDim2.new(0, 0, 1, 0)
    layersReal.Size = UDim2.new(1, 0, 1, -33)
    layersReal.AnchorPoint = Vector2.new(0, 1)
    layersReal.Name = "LayersReal"
    layersReal.Parent = layers
    
    local layersFolder = Instance.new("Folder")
    layersFolder.Name = "LayersFolder"
    layersFolder.Parent = layersReal
    
    local pageLayout = Instance.new("UIPageLayout")
    pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
    pageLayout.Name = "PageLayout"
    pageLayout.Parent = layersFolder
    pageLayout.TweenTime = 0.5
    pageLayout.EasingDirection = Enum.EasingDirection.InOut
    pageLayout.EasingStyle = Enum.EasingStyle.Quad
    
    -- Tab sidebar
    local tabSidebar = Instance.new("Frame")
    tabSidebar.BackgroundTransparency = 1
    tabSidebar.BorderSizePixel = 0
    tabSidebar.Position = UDim2.new(0, 9, 0, 50)
    tabSidebar.Size = UDim2.new(0, guiConfig["Tab Width"], 1, -59)
    tabSidebar.Name = "TabSidebar"
    tabSidebar.Parent = main
    
    local sidebarCorner = Instance.new("UICorner")
    sidebarCorner.CornerRadius = UDim.new(0, 2)
    sidebarCorner.Parent = tabSidebar
    
    local tabListSection = Instance.new("Frame")
    tabListSection.BackgroundTransparency = 1
    tabListSection.BorderSizePixel = 0
    tabListSection.Size = UDim2.new(1, 0, 1, 0)
    tabListSection.Name = "TabListSection"
    tabListSection.Parent = tabSidebar
    
    local tabScroll = Instance.new("ScrollingFrame")
    tabScroll.CanvasSize = UDim2.new(0, 0, 1, 0)
    tabScroll.ScrollBarThickness = 0
    tabScroll.Active = true
    tabScroll.BackgroundTransparency = 1
    tabScroll.BorderSizePixel = 0
    tabScroll.Size = UDim2.new(1, 0, 1, 0)
    tabScroll.Name = "TabScroll"
    tabScroll.Parent = tabListSection
    
    local tabListLayout = Instance.new("UIListLayout")
    tabListLayout.Padding = UDim.new(0, 3)
    tabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabListLayout.Parent = tabScroll
    
    -- Update canvas size
    local function updateTabCanvas()
        local totalHeight = 0
        for _, child in ipairs(tabScroll:GetChildren()) do
            if child:IsA("Frame") then
                totalHeight = totalHeight + child.Size.Y.Offset + 3
            end
        end
        tabScroll.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
    end
    
    tabScroll.ChildAdded:Connect(updateTabCanvas)
    tabScroll.ChildRemoved:Connect(updateTabCanvas)
    
    -- User profile
    if guiConfig.ShowUser and UserInfo.CreateUserProfile then
        tabListSection.Size = UDim2.new(1, 0, 0.7, 0)
        
        local userProfileSection = Instance.new("Frame")
        userProfileSection.BackgroundTransparency = 1
        userProfileSection.BorderSizePixel = 0
        userProfileSection.Size = UDim2.new(1, 0, 0.3, 0)
        userProfileSection.Position = UDim2.new(0, 0, 0.7, 0)
        userProfileSection.Name = "UserProfileSection"
        userProfileSection.Parent = tabSidebar
        
        local profileDivider = Instance.new("Frame")
        profileDivider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        profileDivider.BackgroundTransparency = 0.5
        profileDivider.BorderSizePixel = 0
        profileDivider.Size = UDim2.new(1, -10, 0, 1)
        profileDivider.Position = UDim2.new(0, 5, 0, 0)
        profileDivider.Parent = userProfileSection
        
        if guiConfig.UserProfileType == "full" then
            guiFunc.UserProfile = UserInfo.CreateUserProfile(userProfileSection, true, guiConfig.Uitransparent, guiConfig.Color)
        else
            guiFunc.UserProfile = UserInfo.CreateSimpleUserProfile(userProfileSection, true, guiConfig.Uitransparent, guiConfig.Color)
        end
    end
    
    -- Window functions
    function guiFunc:DestroyGui()
        if screenGui and screenGui.Parent then
            screenGui:Destroy()
        end
    end
    
    function guiFunc:SetTransparency(transparency)
        return applyUITransparency(main, transparency)
    end
    
    function guiFunc:SetNotifySize(size)
        if type(size) == "number" and size >= 200 and size <= 800 then
            DEFAULT_NOTIFY_SIZE = size
            
            local notifyGui = CoreGui:FindFirstChild("NotifyGui")
            if notifyGui and notifyGui:FindFirstChild("NotifyLayout") then
                notifyGui.NotifyLayout.Size = UDim2.new(0, size, 1, 0)
                notifyGui.NotifyLayout:SetAttribute("NotifySize", size)
            end
            return true
        end
        return false
    end
    
    -- Toggle button
    function guiFunc:ToggleUI()
        local toggleGui = Instance.new("ScreenGui")
        toggleGui.Parent = CoreGui
        toggleGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        toggleGui.Name = "ToggleUIButton"
        
        local toggleButton = Instance.new("ImageLabel")
        toggleButton.Parent = toggleGui
        toggleButton.Size = UDim2.new(0, 40, 0, 40)
        toggleButton.Position = UDim2.new(0, 20, 0, 100)
        toggleButton.BackgroundTransparency = 1
        toggleButton.Image = "rbxassetid://" .. guiConfig.Image
        toggleButton.ScaleType = Enum.ScaleType.Fit
        
        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 6)
        buttonCorner.Parent = toggleButton
        
        local button = Instance.new("TextButton")
        button.Parent = toggleButton
        button.Size = UDim2.new(1, 0, 1, 0)
        button.BackgroundTransparency = 1
        button.Text = ""
        
        button.MouseButton1Click:Connect(function()
            if shadowHolder then
                shadowHolder.Visible = not shadowHolder.Visible
            end
        end)
        
        -- Draggable toggle button
        local dragging = false
        local dragStart, startPos
        
        local function updateDrag(input)
            local delta = input.Position - dragStart
            toggleButton.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
        
        button.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = toggleButton.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                updateDrag(input)
            end
        end)
    end
    
    guiFunc:ToggleUI()
    
    -- Set window size
    local titleWidth = titleLabel.TextBounds.X
    local footerWidth = footerLabel.TextBounds.X
    local totalWidth = math.max(115 + titleWidth + footerWidth, 640)
    shadowHolder.Size = UDim2.new(0, totalWidth, 0, 350)
    
    makeDraggable(top, shadowHolder)
    
    -- Minimize functionality
    minBtn.Activated:Connect(function()
        createClickEffect(minBtn, Mouse.X, Mouse.Y)
        shadowHolder.Visible = false
    end)
    
    -- Close confirmation dialog
    closeBtn.Activated:Connect(function()
        createClickEffect(closeBtn, Mouse.X, Mouse.Y)
        
        local overlay = Instance.new("Frame")
        overlay.Size = UDim2.new(1, 0, 1, 0)
        overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        overlay.BackgroundTransparency = 0.3
        overlay.ZIndex = 50
        overlay.Parent = shadowHolder
        
        local dialog = Instance.new("ImageLabel")
        dialog.Size = UDim2.new(0, 300, 0, 150)
        dialog.Position = UDim2.new(0.5, -150, 0.5, -75)
        dialog.Image = "rbxassetid://9542022979"
        dialog.ImageTransparency = 0
        dialog.BorderSizePixel = 0
        dialog.ZIndex = 51
        dialog.Parent = overlay
        
        local dialogCorner = Instance.new("UICorner")
        dialogCorner.CornerRadius = UDim.new(0, 8)
        dialogCorner.Parent = dialog
        
        local glow = Instance.new("Frame")
        glow.Size = UDim2.new(0, 310, 0, 160)
        glow.Position = UDim2.new(0.5, -155, 0.5, -80)
        glow.BackgroundTransparency = 0.75
        glow.BorderSizePixel = 0
        glow.ZIndex = 50
        glow.Parent = overlay
        
        local glowCorner = Instance.new("UICorner")
        glowCorner.CornerRadius = UDim.new(0, 10)
        glowCorner.Parent = glow
        
        local gradient = Instance.new("UIGradient")
        gradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 191, 255)),
            ColorSequenceKeypoint.new(0.25, Color3.fromRGB(255, 255, 255)),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 140, 255)),
            ColorSequenceKeypoint.new(0.75, Color3.fromRGB(255, 255, 255)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 191, 255))
        })
        gradient.Rotation = 90
        gradient.Parent = glow
        
        local dialogTitle = Instance.new("TextLabel")
        dialogTitle.Size = UDim2.new(1, 0, 0, 40)
        dialogTitle.Position = UDim2.new(0, 0, 0, 4)
        dialogTitle.BackgroundTransparency = 1
        dialogTitle.Font = Enum.Font.GothamBold
        dialogTitle.Text = CURRENT_CONFIG_NAME .. " Window"
        dialogTitle.TextSize = 22
        dialogTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
        dialogTitle.ZIndex = 52
        dialogTitle.Parent = dialog
        
        local message = Instance.new("TextLabel")
        message.Size = UDim2.new(1, -20, 0, 60)
        message.Position = UDim2.new(0, 10, 0, 30)
        message.BackgroundTransparency = 1
        message.Font = Enum.Font.Gotham
        message.Text = "Do you want to close this window?\nYou will not be able to open it again"
        message.TextSize = 14
        message.TextColor3 = Color3.fromRGB(200, 200, 200)
        message.TextWrapped = true
        message.ZIndex = 52
        message.Parent = dialog
        
        local yesBtn = Instance.new("TextButton")
        yesBtn.Size = UDim2.new(0.45, -10, 0, 35)
        yesBtn.Position = UDim2.new(0.05, 0, 1, -55)
        yesBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        yesBtn.BackgroundTransparency = 0.935
        yesBtn.Text = "Yes"
        yesBtn.Font = Enum.Font.GothamBold
        yesBtn.TextSize = 15
        yesBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        yesBtn.TextTransparency = 0.3
        yesBtn.ZIndex = 52
        yesBtn.Name = "Yes"
        yesBtn.Parent = dialog
        
        local yesCorner = Instance.new("UICorner")
        yesCorner.CornerRadius = UDim.new(0, 6)
        yesCorner.Parent = yesBtn
        
        local cancelBtn = Instance.new("TextButton")
        cancelBtn.Size = UDim2.new(0.45, -10, 0, 35)
        cancelBtn.Position = UDim2.new(0.5, 10, 1, -55)
        cancelBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        cancelBtn.BackgroundTransparency = 0.935
        cancelBtn.Text = "Cancel"
        cancelBtn.Font = Enum.Font.GothamBold
        cancelBtn.TextSize = 15
        cancelBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        cancelBtn.TextTransparency = 0.3
        cancelBtn.ZIndex = 52
        cancelBtn.Name = "Cancel"
        cancelBtn.Parent = dialog
        
        local cancelCorner = Instance.new("UICorner")
        cancelCorner.CornerRadius = UDim.new(0, 6)
        cancelCorner.Parent = cancelBtn
        
        yesBtn.MouseButton1Click:Connect(function()
            screenGui:Destroy()
            local toggleBtn = CoreGui:FindFirstChild("ToggleUIButton")
            if toggleBtn then
                toggleBtn:Destroy()
            end
        end)
        
        cancelBtn.MouseButton1Click:Connect(function()
            overlay:Destroy()
        end)
    end)
    
    -- Tabs
    local tabs = {}
    local tabCount = 0
    local dropdownCount = 0
    
    function tabs:AddTab(tabConfig)
        tabConfig = tabConfig or {}
        tabConfig.Name = tabConfig.Name or "Tab"
        tabConfig.Icon = tabConfig.Icon or ""
        
        local tabFrame = Instance.new("Frame")
        tabFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        tabFrame.BackgroundTransparency = tabCount == 0 and 0.92 or 1
        tabFrame.BorderSizePixel = 0
        tabFrame.LayoutOrder = tabCount
        tabFrame.Size = UDim2.new(1, 0, 0, 30)
        tabFrame.Name = "Tab"
        tabFrame.Parent = tabScroll
        
        local tabCorner = Instance.new("UICorner")
        tabCorner.CornerRadius = UDim.new(0, 4)
        tabCorner.Parent = tabFrame
        
        local tabButton = Instance.new("TextButton")
        tabButton.Font = Enum.Font.GothamBold
        tabButton.Text = ""
        tabButton.BackgroundTransparency = 1
        tabButton.BorderSizePixel = 0
        tabButton.Size = UDim2.new(1, 0, 1, 0)
        tabButton.Name = "TabButton"
        tabButton.Parent = tabFrame
        
        local tabIcon = Instance.new("ImageLabel")
        tabIcon.BackgroundTransparency = 1
        tabIcon.BorderSizePixel = 0
        tabIcon.Position = UDim2.new(0, 9, 0, 7)
        tabIcon.Size = UDim2.new(0, 16, 0, 16)
        tabIcon.Name = "TabIcon"
        tabIcon.Parent = tabFrame
        
        local iconImage = getIcon(tabConfig.Icon)
        if iconImage ~= "" then
            tabIcon.Image = iconImage
        end
        
        local tabName = Instance.new("TextLabel")
        tabName.Font = Enum.Font.GothamBold
        tabName.Text = "| " .. tabConfig.Name
        tabName.TextColor3 = Color3.fromRGB(255, 255, 255)
        tabName.TextSize = 13
        tabName.TextXAlignment = Enum.TextXAlignment.Left
        tabName.BackgroundTransparency = 1
        tabName.BorderSizePixel = 0
        tabName.Size = UDim2.new(1, 0, 1, 0)
        tabName.Position = UDim2.new(0, 30, 0, 0)
        tabName.Name = "TabName"
        tabName.Parent = tabFrame
        
        -- Active indicator
        if tabCount == 0 then
            pageLayout:JumpToIndex(0)
            tabNameLabel.Text = tabConfig.Name
            
            local indicator = Instance.new("Frame")
            indicator.BackgroundColor3 = guiConfig.Color
            indicator.BorderSizePixel = 0
            indicator.Position = UDim2.new(0, 2, 0, 9)
            indicator.Size = UDim2.new(0, 1, 0, 12)
            indicator.Name = "Indicator"
            indicator.Parent = tabFrame
            
            local indicatorStroke = Instance.new("UIStroke")
            indicatorStroke.Color = guiConfig.Color
            indicatorStroke.Thickness = 1.6
            indicatorStroke.Parent = indicator
            
            local indicatorCorner = Instance.new("UICorner")
            indicatorCorner.Parent = indicator
        end
        
        -- Tab switching
        tabButton.Activated:Connect(function()
            createClickEffect(tabButton, Mouse.X, Mouse.Y)
            
            local currentIndicator = nil
            for _, frame in ipairs(tabScroll:GetChildren()) do
                if frame:IsA("Frame") and frame:FindFirstChild("Indicator") then
                    currentIndicator = frame.Indicator
                    break
                end
            end
            
            if currentIndicator and tabFrame.LayoutOrder ~= pageLayout.CurrentPage.LayoutOrder then
                for _, frame in ipairs(tabScroll:GetChildren()) do
                    if frame:IsA("Frame") then
                        TweenService:Create(
                            frame,
                            TweenInfo.new(0.3, Enum.EasingStyle.Back),
                            { BackgroundTransparency = 1 }
                        ):Play()
                    end
                end
                
                TweenService:Create(
                    tabFrame,
                    TweenInfo.new(0.6, Enum.EasingStyle.Back),
                    { BackgroundTransparency = 0.92 }
                ):Play()
                
                TweenService:Create(
                    currentIndicator,
                    TweenInfo.new(0.5, Enum.EasingStyle.Quad),
                    { Position = UDim2.new(0, 2, 0, 9 + (33 * tabFrame.LayoutOrder)) }
                ):Play()
                
                pageLayout:JumpToIndex(tabFrame.LayoutOrder)
                
                task.wait(0.05)
                tabNameLabel.Text = tabConfig.Name
                
                TweenService:Create(
                    currentIndicator,
                    TweenInfo.new(0.35, Enum.EasingStyle.Quad),
                    { Size = UDim2.new(0, 1, 0, 20) }
                ):Play()
                
                task.wait(0.2)
                
                TweenService:Create(
                    currentIndicator,
                    TweenInfo.new(0.25, Enum.EasingStyle.Quad),
                    { Size = UDim2.new(0, 1, 0, 12) }
                ):Play()
            end
        end)
        
        -- Content scrolling frame
        local contentScroll = Instance.new("ScrollingFrame")
        contentScroll.ScrollBarThickness = 0
        contentScroll.Active = true
        contentScroll.BackgroundTransparency = 1
        contentScroll.BorderSizePixel = 0
        contentScroll.LayoutOrder = tabCount
        contentScroll.Size = UDim2.new(1, 0, 1, 0)
        contentScroll.Name = "ContentScroll"
        contentScroll.Parent = layersFolder
        
        local contentLayout = Instance.new("UIListLayout")
        contentLayout.Padding = UDim.new(0, 3)
        contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        contentLayout.Parent = contentScroll
        
        -- Update canvas size
        local function updateContentCanvas()
            local totalHeight = 0
            for _, child in ipairs(contentScroll:GetChildren()) do
                if child:IsA("Frame") and child.Name ~= "UIListLayout" then
                    totalHeight = totalHeight + child.Size.Y.Offset + 3
                end
            end
            contentScroll.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
        end
        
        contentScroll.ChildAdded:Connect(updateContentCanvas)
        contentScroll.ChildRemoved:Connect(updateContentCanvas)
        
        -- Sections
        local sections = {}
        local sectionCount = 0
        
        function sections:AddSection(sectionConfig)
            sectionConfig = sectionConfig or {}
            local title = sectionConfig.Title or "Title"
            local alwaysOpen = sectionConfig.AlwaysOpen
            local icon = sectionConfig.Icon or ""
            
            local section = Instance.new("Frame")
            section.BackgroundTransparency = 1
            section.BorderSizePixel = 0
            section.LayoutOrder = sectionCount
            section.ClipsDescendants = true
            section.Size = UDim2.new(1, 0, 0, 30)
            section.Name = "Section"
            section.Parent = contentScroll
            
            local sectionHeader = Instance.new("Frame")
            sectionHeader.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            sectionHeader.BackgroundTransparency = 0.935
            sectionHeader.BorderSizePixel = 0
            sectionHeader.Position = UDim2.new(0.5, 0, 0, 0)
            sectionHeader.Size = UDim2.new(1, -2, 0, 30)
            sectionHeader.AnchorPoint = Vector2.new(0.5, 0)
            sectionHeader.Name = "SectionHeader"
            sectionHeader.Parent = section
            
            local headerCorner = Instance.new("UICorner")
            headerCorner.CornerRadius = UDim.new(0, 4)
            headerCorner.Parent = sectionHeader
            
            local headerButton = Instance.new("TextButton")
            headerButton.Text = ""
            headerButton.BackgroundTransparency = 1
            headerButton.BorderSizePixel = 0
            headerButton.Size = UDim2.new(1, 0, 1, 0)
            headerButton.Name = "HeaderButton"
            headerButton.Parent = sectionHeader
            
            local arrowFrame = Instance.new("Frame")
            arrowFrame.BackgroundTransparency = 1
            arrowFrame.BorderSizePixel = 0
            arrowFrame.Position = UDim2.new(1, -25, 0.5, -10)
            arrowFrame.Size = UDim2.new(0, 20, 0, 20)
            arrowFrame.Name = "ArrowFrame"
            arrowFrame.Parent = sectionHeader
            
            local arrowIcon = Instance.new("ImageLabel")
            arrowIcon.Image = "rbxassetid://16851841101"
            arrowIcon.BackgroundTransparency = 1
            arrowIcon.BorderSizePixel = 0
            arrowIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
            arrowIcon.Rotation = alwaysOpen and 90 or (alwaysOpen == false and 90 or 0)
            arrowIcon.Size = UDim2.new(1, -6, 1, -6)
            arrowIcon.AnchorPoint = Vector2.new(0.5, 0.5)
            arrowIcon.Name = "ArrowIcon"
            arrowIcon.Parent = arrowFrame
            
            local sectionIcon = Instance.new("ImageLabel")
            sectionIcon.BackgroundTransparency = 1
            sectionIcon.BorderSizePixel = 0
            sectionIcon.Position = UDim2.new(0, 10, 0, 7)
            sectionIcon.Size = UDim2.new(0, 16, 0, 16)
            sectionIcon.Name = "SectionIcon"
            sectionIcon.Parent = sectionHeader
            
            local sectionIconImage = getIcon(icon)
            if sectionIconImage ~= "" then
                sectionIcon.Image = sectionIconImage
            else
                sectionIcon.Visible = false
            end
            
            local sectionTitle = Instance.new("TextLabel")
            sectionTitle.Font = Enum.Font.GothamBold
            sectionTitle.Text = title
            sectionTitle.TextColor3 = Color3.fromRGB(230, 230, 230)
            sectionTitle.TextSize = 13
            sectionTitle.TextXAlignment = Enum.TextXAlignment.Left
            sectionTitle.TextYAlignment = Enum.TextYAlignment.Top
            sectionTitle.BackgroundTransparency = 1
            sectionTitle.BorderSizePixel = 0
            sectionTitle.Size = UDim2.new(1, sectionIconImage ~= "" and -70 or -50, 0, 13)
            sectionTitle.Position = UDim2.new(0, sectionIconImage ~= "" and 35 or 10, 0.5, -6.5)
            sectionTitle.AnchorPoint = Vector2.new(0, 0.5)
            sectionTitle.Name = "SectionTitle"
            sectionTitle.Parent = sectionHeader
            
            local divider = Instance.new("Frame")
            divider.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            divider.BorderSizePixel = 0
            divider.Position = UDim2.new(0.5, 0, 0, 33)
            divider.Size = UDim2.new(0, 0, 0, 2)
            divider.AnchorPoint = Vector2.new(0.5, 0)
            divider.Name = "Divider"
            divider.Parent = section
            
            local dividerCorner = Instance.new("UICorner")
            dividerCorner.Parent = divider
            
            local dividerGradient = Instance.new("UIGradient")
            dividerGradient.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 20)),
                ColorSequenceKeypoint.new(0.5, guiConfig.Color),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))
            })
            dividerGradient.Parent = divider
            
            local contentArea = Instance.new("Frame")
            contentArea.BackgroundTransparency = 1
            contentArea.BorderSizePixel = 0
            contentArea.ClipsDescendants = true
            contentArea.Position = UDim2.new(0.5, 0, 0, 38)
            contentArea.Size = UDim2.new(1, -2, 0, 0)
            contentArea.AnchorPoint = Vector2.new(0.5, 0)
            contentArea.Name = "ContentArea"
            contentArea.Parent = section
            
            local contentCorner = Instance.new("UICorner")
            contentCorner.CornerRadius = UDim.new(0, 2)
            contentCorner.Parent = contentArea
            
            local contentLayout = Instance.new("UIListLayout")
            contentLayout.Padding = UDim.new(0, 3)
            contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
            contentLayout.Parent = contentArea
            
            local isOpen = alwaysOpen == true or alwaysOpen == false or false
            
            local function updateSectionSize()
                if isOpen then
                    local totalHeight = 38
                    for _, child in ipairs(contentArea:GetChildren()) do
                        if child:IsA("Frame") and child.Name ~= "UIListLayout" and child.Name ~= "UICorner" then
                            totalHeight = totalHeight + child.Size.Y.Offset + 3
                        end
                    end
                    
                    TweenService:Create(arrowFrame, TweenInfo.new(0.5), { Rotation = 90 }):Play()
                    TweenService:Create(section, TweenInfo.new(0.5), { Size = UDim2.new(1, 0, 0, totalHeight) }):Play()
                    TweenService:Create(contentArea, TweenInfo.new(0.5), { Size = UDim2.new(1, -2, 0, totalHeight - 38) }):Play()
                    TweenService:Create(divider, TweenInfo.new(0.5), { Size = UDim2.new(1, 0, 0, 2) }):Play()
                end
            end
            
            if alwaysOpen == true or alwaysOpen == false then
                isOpen = true
                local totalHeight = 38
                for _, child in ipairs(contentArea:GetChildren()) do
                    if child:IsA("Frame") and child.Name ~= "UIListLayout" and child.Name ~= "UICorner" then
                        totalHeight = totalHeight + child.Size.Y.Offset + 3
                    end
                end
                
                arrowFrame.Rotation = 90
                section.Size = UDim2.new(1, 0, 0, totalHeight)
                contentArea.Size = UDim2.new(1, -2, 0, totalHeight - 38)
                divider.Size = UDim2.new(1, 0, 0, 2)
                updateContentCanvas()
            end
            
            if alwaysOpen ~= true then
                headerButton.Activated:Connect(function()
                    createClickEffect(headerButton, Mouse.X, Mouse.Y)
                    
                    if isOpen then
                        TweenService:Create(arrowFrame, TweenInfo.new(0.5), { Rotation = 0 }):Play()
                        TweenService:Create(section, TweenInfo.new(0.5), { Size = UDim2.new(1, 0, 0, 30) }):Play()
                        TweenService:Create(divider, TweenInfo.new(0.5), { Size = UDim2.new(0, 0, 0, 2) }):Play()
                        isOpen = false
                    else
                        isOpen = true
                        updateSectionSize()
                    end
                    
                    task.wait(0.5)
                    updateContentCanvas()
                end)
            end
            
            contentArea.ChildAdded:Connect(updateSectionSize)
            contentArea.ChildRemoved:Connect(updateSectionSize)
            
            -- Items
            local items = {}
            local itemCount = 0
            
            function items:AddParagraph(config)
                return Elements.AddParagraph(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddPanel(config)
                return Elements.AddPanel(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddButton(config)
                return Elements.AddButton(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddToggle(config)
                return Elements.AddToggle(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddSlider(config)
                return Elements.AddSlider(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddInput(config)
                return Elements.AddInput(contentArea, config, itemCount, updateSectionSize)
            end
            
            function items:AddDropdown(config)
                return Elements.AddDropdown(contentArea, config, itemCount, dropdownCount, shadow, pageLayout, updateSectionSize)
            end
            
            function items:AddKeybind(config)
                if KeybindModule then
                    config = config or {}
                    config.SaveKey = true
                    config.ConfigData = ConfigData
                    config.SaveFunction = saveConfig
                    
                    itemCount = itemCount + 1
                    return KeybindModule.CreateKeybind(contentArea, config, itemCount, updateSectionSize)
                else
                    warn("Keybind module not loaded!")
                    return nil
                end
            end
            
            function items:AddDivider()
                return Elements.AddDivider(contentArea, itemCount, updateSectionSize)
            end
            
            function items:AddSubSection(title)
                return Elements.AddSubSection(contentArea, title, itemCount, updateSectionSize)
            end
            
            sectionCount = sectionCount + 1
            return items
        end
        
        tabCount = tabCount + 1
        return sections
    end
    
    loadConfigElements()
    return tabs
end

return Chloex
